---
title: "Something About Prostate Cancer"
author: "Andrew Bates"
date: "November 15, 2018"
header-includes:
  - \renewcommand{\abstractname}{Executive Summary}
output: 
  bookdown::pdf_document2:
    toc: false
documentclass: article
geometry: margin=1in
fontsize: 11pt
abstract: "In this paper we investigate various prostate exam results and their relationship with tumor pentration of the prostatic capsule. A logistic regression model is constructed based on a subset of data collected by the Ohio State University Comprehensive Cancer Center in order to quantify the relationship. The components of the model are the results of a digital rectal exam, total Gleason score, and prostate specific antigen value. The most significant factor is whether a nodule was detected in a digital rectal exam. Presence of a nodule is associated with up to a 4.7 times increase in odds of tumor pentration compared to absence of a nodule. Provided the other variables are fixed, a one unit increase in Gleason score is associated with a 2.7 times increase in odds of tumor penetration. Prostate specific antigen value is related to tumor penetration via a 3% increase in odds of penetration for each additional mg/ml increase. We also assess the potential of using the model as an overall diagnostic tool that combines the results of a digital rectal exam, prostate specific antigen value and Gleason score into a single measure of risk, rather than considering each measure individually."
---


```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(here)  # handles directories
library(readr)  # read in data
library(MASS) # stepwise regression
library(dplyr)  # manipulate data
library(forcats) # handle factors
library(ggplot2)  # plotting
library(broom) # tidy model output
library(gridExtra) # matrix of ggplot's 
library(pROC) # assess predictions

library(knitr)  # table formatting
library(kableExtra) # table formatting

prostate_raw <- read_tsv(here("data", "prostate.txt"))
# remove id, rename
prostate <- prostate_raw %>%
  select(-id)

prostate <- prostate %>%
  rename(
    penetrate = capsule,
    dre = dpros,
    caps = dcaps
  )

# re-encode variables
prostate <- prostate %>%
  mutate(
    penetrate = as.factor(penetrate),
    race = as.factor(race),
    dre = as.factor(dre),
    caps = as.factor(caps)
  ) %>%
  mutate(
    penetrate = fct_recode(penetrate, yes = "1", no = "0"),
    race = fct_recode(race, white = "1", black = "2"),
    caps = fct_recode(caps, no = "1", yes = "2"),
    dre = fct_recode(dre,
                     "no nodule" = "1",
                     "unilobar left" = "2",
                     "unilobar right" = "3",
                     "bilobar" = "4")
  )
# remove missing observations
prostate <- prostate %>%
  filter(!is.na(race))
```



# Introduction

Prostate cancer is one of the most common cancers among males. Early detection is crucial because treatment can often be successful if the cancer is found early enough to where a spread to other parts of the body have not occured. In this paper we investigate the relationship between the results of various prostate related exams and whether tumor penetration of the prostatic capsule has occured. The primary purpose of this analysis is to determine if there are any factors that have a particularly influential relationship with prostate capsule penetration. A secondary aim is to develop a method to use the model resulting from the primary analysis as a diagnostic aid that merges the results of several exams into a single risk measure instead of considering each result independently.



# Methods

In this analysis we examine a subset of data collected by the Ohio State University Comprehensive Cancer Center as part of a study to determine the potential of standard exam results to predict whether a tumor will penetrate the prostatic capsule. Out of 380 patients, 153 have experienced capsule penetration and 227 have not. The data set contains six explanatory variables: the patients age and race, results of a digital rectal exam (DRE), whether capsular involvement was detected, prostate specific antigen (PSA) value, and total Gleason score. Also included in the data set was an identification code which is not used in the analysis as it simply identifies the patient. For a detailed description of each variable see Table \@ref(tab:var-desc). There are two continuous variables, PSA and age, and the remaining variables are categorical. Observe that race is recorded as only Black or White. This may be the reason why three observations contain missing values for race. Perhaps three of the patients were neither Black nor White. However, without access to the details of the study we can only speculate. Furthermore, the other variables in these observations do not point to any particular reason as to why race is not recorded[^1]. Because of this, we decided to omit these three observations. The data set used for analysis then, consists of 377 observations. Of these, 151 patients have experienced tumor penetration of the prostatic capsule, and 226 have not.


To investigate the relationship between the covariates and tumor penetration status, we use a logistic regression model. The response is especially well balanced with 40% of the observations having capsular penetration and 60% not having penetration. As such, procedures designed to assist with class imbalances, such as downsampling, are not considered in this analysis. In addition to the explanatory variables included in the data set, all two-way interaction terms are examined. Using this as a starting point, the model is chosen via a backwards elimination procedure using Akaike Information Criteria (AIC) as the model selection criterion. In the model constructed with this procedure age and race are not significant at the 0.05 level so they are subsequently removed along with any associated interaction terms.

Diagnostics of the resulting model are performed via explanatory variable patterns and a Hosmer-Lemeshow goodness-of-fit test. The strength of the relationship between the covariates and tumor penetration of the prostatic capsule is measured by the odds ratio. The predictive power of the model is evaluated by the area under the receiver operating characteristic curve. A method based on predictions from the model is proposed as a tumor penetration diagnostic tool to assist physicians in determining if further investigation of a given patient is warranted. The analysis is conducted using the statistical software R and the report is written using the R Markdown package. The R code is available in the appendix. All other materials used in this analysis are available online at `https://github.com/asbates/stat696/tree/master/reports/prostate-cancer`.


```{r var-desc}
description <- data.frame(
  Name = c("penetrate", "age", "race", "dre", "caps", "psa", "gleason"),
  Description = c("Tumor penetration of prostatic capsule?", "Patient age", "Patient race", "Results of digital rectal exam", "Detection of capsular involvement?", "Prostate specific antigen value", "Total Gleason score"),
  Details = c("Yes, no", "Years", "Black, White", "No nodule, unilobar left, unilobar right, bilobar", "Yes, no", "mg/ml", "0 - 10")
)

kable(description,
      caption = "Description of variables in the data set.") %>%
  row_spec(0, bold = TRUE)

```


[^1]: As in, some have experienced capusle penetration, the ages and PSA scores vary significantly across the observations, etc.

# Analysis

## Exploratory Analysis

We begin by inspecting tables of the categorical variables against whether tumor penetration has occured. Rather than examing contingency tables of counts, we find it more informative to view tables marginalized by the covariates. This provides more context by allowing us to see, for example, the proportion of Black patients who had tumor penetration and the proportion who did not. Table \@ref(tab:dre-tab) displays the proportion of patients who did and did not experience tumor penetration of the prostatic capsule grouped by the results of a digital rectal exam. It shows that the majority of patients who do not have a nodule have not experience tumor penetration. For those patients who did have a nodule, the rate of tumor penetration is reversed. The most pronounced difference is for patients who had a bilobar nodule with 65% experiencing tumor penetration. The relationship we see here tells us that DRE results will likely be a valuable predictor.


```{r dre-tab}
dre_tab <- table(prostate$penetrate, prostate$dre) %>%
  prop.table(., margin = 2) * 100 
rownames(dre_tab) <- c("No Penetration", "Penetration")
dre_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Results of digital rectal exam vs. whether tumor pentration of prostatic capsule occured, marginalized by the digital rectal exam results.") %>% 
  add_header_above(c(" " = 1, "DRE Result" = 4), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```

The relationship for the remaining categorical variables can be found in Tables \@ref(tab:app-race-tab) to \@ref(tab:app-gleason-tab) in the appendix. For detection of capsular involvment and Gleason score, we find a similar story as DRE results. For patients where capsular involvement was detected, tumor penetration occured at more than twice the rate than patients where involvement was not detected (35% vs. 75%). As Gleason score increases from zero to nine, the tumor penetration rate increases from zero to 92%. Where we do not see a significant change in the rate of tumor penetration is with race. Both Black and White patients have a tumor penetration rate of approximately 40%.

For the numeric variables, we examine summary statistics and plots of age and PSA grouped by whether prostatic capusle penetration has occured. Summary statistics and a box plot for age can be found in Table \@ref(tab:app-age-sum) and Figure \@ref(fig:app-age-box). There is virtually no difference in the age distribution of patients who have experience tumor penetration and those who have not. As such, we do not expect it to make a significant contribution to our model. On the other hand, PSA value seems like it may be an important predictor.
Figure \@ref(fig:psa-hist) is a histogram of PSA value where color indicates tumor penetration of the prostatic capsule. The distribution has a similar shape for low PSA values however, for PSA values above 67 mg/ml there are no cases where tumor penetration has occured. 


```{r psa-hist, fig.cap = "Histogram of prostate specific antigen value colored by whether tumor penetration of prostatic capsule occured.", fig.height = 3, fig.width = 6}
ggplot(prostate, aes(x = psa, fill = penetrate)) +
  geom_histogram(bins = 50) +
  theme_classic()
```




## Modeling

```{r model-setup}
best_step <- glm(penetrate ~ age + race + dre + psa + gleason + 
    age:dre + age:gleason + race:psa, 
    family = binomial(link = "logit"), 
    data = prostate)

```


To model the relationship between tumor penetration and the predictor variables, we use a logistic regression model. As most of the covariates are tests covering different aspects of of the prostate, it is not hard to imagine there some of them connected in their relationship with tumor penetration. For this reason, the initial model is fit using all first-order interaction terms. This serves as the starting point for model selection which is done via stepwise regression with AIC as the selection criteria. The model chosen via the stepwise procedure includes race, age, DRE results, PSA value, and Gleason score as well as age interacted with DRE result and race interacted with PSA value. A detailed summary can be found in Table \@ref(tab:app-best-step-sum). We note here that the AIC is `r round(best_step$aic, 0)` and the p-values for age and race are quite high at 0.11 and 0.99, respectively.

Since some of the p-values of the model obtained via stepwise regression are large, we remove these terms and refit our model. Specifically, we remove age and race along with interaction terms associated with them. We can not justify keeping variables in interactions that themselves are not included in the model. Note that for this model, removing the relevant interaction terms actually means removing all interaction terms. Once this is done, we are left with a model that relates tumor penetration to just three variables: DRE results, PSA value, and Gleason score.

## Diagnostics

```{r diag-setup}
# note: we're using the 'raw' data here with the default encoding
pros_diag <- prostate_raw %>% 
  rename(
    penetrate = capsule,
    dre = dpros,
    caps = dcaps
  )

# Create EVPs by binning continuous covariates
g <- 5 # number of categories
psa_interval = cut(pros_diag$psa,
                   quantile(pros_diag$psa, 0:g/g), include.lowest = TRUE)

w <- aggregate(penetrate ~ psa_interval + gleason + dre,
               data = pros_diag,
               FUN = sum)
n <- aggregate(penetrate ~ psa_interval + gleason + dre,
               data = pros_diag,
               FUN = length)
wn <- data.frame(
  w,
  trials = n$penetrate, 
  prop = round(w$penetrate / n$penetrate, 2)
)


diag_fit <- glm(penetrate/trials ~ psa_interval + gleason + dre,
           data = wn,
           family = binomial(link = "logit"),
           weights = trials)

# add relavent values (cooks d, etc.) to data
aug_diag <- augment(diag_fit, 
                    data = wn,
                    type.predict = "response")

# for some reason, augment() is only returning deviance residuals
aug_diag <- aug_diag %>% 
  mutate(
    .std.resid = rstandard(diag_fit, type = "pearson")
  )

p <- length(diag_fit$coefficients)
cook_cutoff <- 4 / nrow(wn)
h_cutoff2 <- 2 * p / nrow(wn)
h_cutoff3 <- 3 * p / nrow(wn)

source(here("reports", "prostate-cancer", "code", "HLTest.R"))

# 6 groups used b/c that's minimum number such that expected counts are
#  greater than 5
hl_test <- HLTest(diag_fit, 6)

```


To assess the model we use diagnostic tools on explanatory variable patterns[^2] (EVP). We collapse the orginal data into groups where each group shares the same covariate values. Recall that one of the variables, PSA, is continous so we first cut the values into nonoverlapping bins. Then we fit the model to the EVPs using the number of original observations in each EVP as weights. Standardized Pearson residuals, Cook's distance, and leverage from the EVP model are what we use to perform our diagnostics. A plot of the residuals vs. fitted probabilites is shown in Figure \@ref(fig:resid-plot). The dotted horizontal lines indicate the standard cut off values of -3, -2, 2, and 3. There are no discernible patterns in the residuals and they are scattered roughly equally about zero. For larger fitted probabilities there is a bit more variability in the residuals but nothing too concerning. One EVP (lower right hand corner of plot) is slightly smaller than the lowest cut off bound, having a value of `r round(aug_diag[73, ]$.std.resid, 1)`. This is only a minor violation and the cut off values are simply rules-of-thumb so we consider this EVP satisfactory.

Further diagnostic plots can be found in Figure \@ref(fig:app-diag-plots) in the appendix. Only one other EVP is of any concern as its Cook's distance and leverage values are both outside the standard cut off values. However, this EVP is also only faintly outside the boundaries[^3]. Twenty two of the original observations are contained in this EVP. Given that the Cook's distance and leverage for this EVP are just barely outside their respective cut off, this is not enough justification to remove this many data points.

As a final diagnostic measure we perform a Homer-Lemeshow goodness-of-fit test using the model fit to the EVPs. The EVP data is separated into bins according ot quantiles of the fitted values. Then observed and expected counts are computed for each bin and a $\chi^2$ test is performed. This test is an overall assessment of how well the model fits the data. The obtained test statistic is `r round(hl_test$statistic[[1]], 1)` with a corresponding p-value of `r round(hl_test$p.value, 2)`. The p-value may seem unfruitful at first as we are typically looking for small values. However in the situation at hand this is not the case. The null hypothesis in this test is that the model fits the data well so we do _not_ want to reject the null in our situation. So based on this test our model seems to fit the data well and we can move on to inferences.


```{r resid-plot, fig.height = 3, fig.width = 6, fig.cap = "Pearson residuals vs. fitted values via Explanatory Variable Patterns (74). The horizontal reference lines indicate the usual residual cutoffs of +-2 and +- 3."}
ggplot(aug_diag, aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 2, linetype = "dotted") +
  geom_hline(yintercept = 3, linetype = "dotted") +
  geom_hline(yintercept = -2, linetype = "dotted") +
  geom_hline(yintercept = -3, linetype = "dotted") +
  ylab("Standardized Residuals") +
  xlab("Fitted Values") +
  theme_classic()
```


[^2]: Also called covariate patterns.
[^3]: Cook's distance = `r round(aug_diag[25, ]$.cooksd, 2)`, leverage = `r round(aug_diag[25, ]$.hat, 2)` with cutoff values of `r round(cook_cutoff, 2)` and `r round(h_cutoff3, 2)`.

## Inferences

```{r inf-setup}
final_fit <- glm(penetrate ~ dre + psa + gleason,
                 data = prostate,
                 family = binomial(link = "logit"))

fit_roc <- roc(prostate$penetrate, predict(final_fit, type = "response"))
```


Table \@ref(tab:model-summary) contains a summary of the final model used in this analysis. Included in the table are estimates for the coefficients with their associated standard errors and p-values. Also include are the odds ratio for each term and 95% confidence intervals for the odds ratio. The largest odds ratio corresponds to a digital rectal exam where a unilobar nodule is found on the patient's ride side. The odds of experiencing tumor penetration of the prostatic capsule for such patients is `r round(exp(coefficients(final_fit))[3], 2)` times more than the odds for patients which did not have a nodule present. Interestingly, the odds for patients with a unilobar nodule on the left are about half the odds of tumor pentration for patients with either a nodule on the right or a bilobar nodule. The odds ratio for Gleason score indicates that each unit increase in score corresponds to increase in odds of `r round(exp(coefficients(final_fit))[6],2)` times, if all other variables are held constant. Since the odds ratio for PSA is smaller than two, it has a slightly different interpretation. One additional mg/ml of PSA is associated with a `r round(1 - exp(-coefficients(final_fit))[5],2) * 100`% increase in odds when the remaining variables are unchanged.


```{r model-summary}
tidy(final_fit, conf.int = TRUE) %>% 
  mutate(
    Term = c("Intercept", "DRE: unilobar left", "DRE: unilobar right", "DRE: bilobar nodule", "Prostate specific antigen value", "Gleason score"),
    Estimate = formatC(signif(estimate, 4), 2, format = "f"),
    SE = formatC(signif(std.error, 4), 2, format = "f"),
    `p-value` = formatC(signif(p.value, 5), 3, format = "f"),
    `Odds ratio` = formatC(signif(exp(estimate), 4), 2, format = "f"),
    `OR 95% CI` = paste("(", 
                        formatC(signif(exp(conf.low), 4), 2, format = "f"),
                        ", ",
                        formatC(signif(exp(conf.high), 4), 2, format = "f"),
                        ")"
                        )
  ) %>% 
  select(Term, Estimate, SE, `p-value`, `Odds ratio`, `OR 95% CI`) %>% 
  kable(align = c("l", "r", "r", "r", "r", "r"), caption = "Summary for final model fitting tumor penetration of prostatic capsule with covariates digital rectal exam result, prostate specific antigen value, and total Gleason score. Coefficient estimates with standard errors and p-values are provided along with odds ratios and 95\\% confidence intervals for odd ratios. AIC for the model is 393.") %>% 
  row_spec(0, bold = TRUE)
```


In addition to making inferences on the odds ratios of each of the variables in our model, we can assess the models potential predictive ability. The primary goal of this analysis is to determine which factors have a particularly strong influence on tumor penetration. This is not a prediction problem per se and so we did not follow the usual paradigm of splitting our data into a training and testing set. This means that the predictions we consider here are in sample predictions and will no doubt have much better performance than what would actually be seen in practice. Nonetheless, we can still get some sense of how well the model performs at predicting tumor penetration. To that end, we plotted a receiver operating characteristic (ROC) curve which we leave in the appendix (Figure \@ref(fig:app-roc)) for the curious reader. The curve indicates that our model performs significantly better than the default comparison of randomly assigning whether tumor penetration will occur. The area under the ROC curve (AUC) for our final model was `r round(fit_roc$auc, 2)` which is quite good. The ROC curve and AUC indicate that the model developed here has potential as an overall diagnostic tool that combines the results of a digital rectal exam, prostate specific antigen value, and Gleason score into a single measure of risk, rather than considering each measure individually.


We now illustrate how our model can be used as the aformentioned diagnostic tool. Let us suppose that we have three patients who have had a digitial rectal exam, have a PSA test done, and have received a Gleason score. Of course in reality we would have this information available but for the sake of demonstration we will use hypothetical values. The predictions are easy to obtain with software so we will focus on what to do once we have the predictions. Table \@ref(tab:preds) presents the supposed values as well as the probability of tumor penetration obtained from the model. Doctors would likely be satisfied with the first two patients whose predicted probability of tumor penetration are quite low. However, further investigation would likely be desired for the third patient how has a reasonably high chance of tumor penetration according to the model. 

But is this probability really that high? What if it was 0.85 instead of 0.88? How would we determine what is considered 'high' and what is considered 'low'? One way we can do this is by considering the false positive rate and the false negative rate. We start by setting a cutoff value, say 0.85, for which values above we say that tumor penetration has occured and otherwise we say that it has not. Patients with scores above the cutoff would warrant a deeper investigation while patients below the cutoff would proceed with a regular prostate exam schedule. A false postive occurs when we say tumor pentration has occured when it actually has not. Similarly, a false negative is when we claim that tumor penetration has not occured when it actually has. Both false positives and false negatives are inevitable so the game here is to find an appropriate balance between the two and determine which one is more important. For example, we may want to minimize the false negative rate because this means a patient walks away thinking they have not experienced tumor penetration when in reality they have. Ultimately, a team of physicians would need to weigh the costs and benefits of an incorrect prediction from which an appropriate cutoff value can be determined.


```{r preds}
new_data <- data.frame(
  dre = c("no nodule", "unilobar right", "no nodule"),
  psa = c(15.26, 8.70, 80.42),
  gleason = c(6, 4, 8)
)

augment(final_fit, newdata = new_data, type.predict = "response") %>% 
  mutate(
    `DRE result` = dre,
    `PSA value` = psa,
    `Gleason score` = gleason,
    `Predicted value` = formatC(signif(.fitted, 4), 2, format = "f")
  ) %>% 
  select(`DRE result`, `PSA value`, `Gleason score`, `Predicted value`) %>% 
  kable(align = c("l", "r", "r", "r"), caption = "Hypothetical values for DRE result, PSA value, and Gleason score along with predicted probability of tumor pentration of prostatic capsule obtained from the model.")
```





# Conclusion

In this analysis we developed a logistic regression model to aid in the understanding of how various factors relate to tumor penetration of the prostatic capsule. Along with this we compared the strength of the relationship by examing the odds ratio for each factor. The patient's age and race were not included in the model from which we can infer that these have a weak relationship with tumor penetration, if any. The most significant factor was whether a nodule was detected in a digital rectal exam. Presence of a unilobar nodule on the right relates to a 4.7 times increase in odds than for patients with no nodule detected. An increase in Gleason score by one is associated with a 2.7 times increase in odds provided the remaining covariates are fixed. For a one mg/ml increase in prostate specific antigen value, we can expect a 3% increase in odds if the other variables remain constant. The predictive power of the model was assessed via AUC which was 0.82. This led us to believe the model has the potential to be used as a tool to help determine if a given patient has experienced tummor penetration. We also discussed how the model can be used in practice for this purpose.

We should note that the analyis performed here does have its limitations. The most obvious of these limitations is the population that the data represents. Although race and age were not included in the model, they do limit our inferences because they were quite limited in scope. Only Black and White patients were included in this data set and 75% of the patients were over 62 years of age. One needs to be careful not to extrapolate outside this population.

Another aspect of this analysis that should be handled with care is using the model developed to predict tumor penetration. The predictive capability assessment of this analysis was done on data that was used to fit the model. These predictions will no doubt be an overestimate of the ability of predictions on previously unseen data. If it is desired to use this model as a primary method to determine if a patient has experienced tumor penetration, a different approach should be followed than was done in this analysis such as splitting the data into a training and testing set to estimate its out of sample predictive performance. One would likely also want to determine a cutoff point as this model outputs probabilities and not yes-no decisions. This has its own inherent difficulties. Experts would need to determine an acceptable level of false postives and false negatives and an apropriate balance between the two.




\newpage

# Appendix {-}

# (APPENDIX) Appendix A {-}


# Exploratory Analysis

## Tables

```{r app-race-tab}
race_tab <- table(prostate$penetrate, prostate$race) %>% 
  prop.table(., margin = 2) * 100
rownames(race_tab) <- c("No Penetration", "Penetration")
race_tab %>% 
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>%
  kable(caption = "Race vs. whether tumor penetration of prostatic capsule has occured, marginalized by race.") %>%
  add_header_above(c(" " = 1, "Race" = 2), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```


```{r app-caps-tab}
caps_tab <- table(prostate$penetrate, prostate$caps) %>%
  prop.table(., margin = 2) * 100
rownames(caps_tab) <- c("No Penetration", "Tumor Penetration")
caps_tab %>%
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Detection of capsular involvement vs. whether tumor pentration of prostatic capsule occured, marginalized by capsular involvment.") %>% 
  #column_spec(1, bold = TRUE, border_left = TRUE) %>% 
  #column_spec(3, border_right = TRUE) %>% 
  add_header_above(c(" ", "Capsular Involvement" = 2), bold = TRUE) %>% 
  column_spec(1, bold = TRUE)

```


```{r app-gleason-tab}
gleason_tab <- table(prostate$penetrate, prostate$gleason) %>%
  prop.table(., margin = 2) * 100
rownames(gleason_tab) <- c("No Penetration", "Tumor Penetration")
gleason_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Total Gleason score vs. whether tumor penetration of prostatic capsule occured, marginalized by Gleason score.") %>%
  add_header_above(c(" ", "Gleason Score" = 7), bold = TRUE) %>%
  column_spec(1, bold = TRUE)
```


```{r app-age-sum}
age_summary <- prostate %>% 
  group_by(penetrate) %>%
  summarise(
    min = min(age),
    median = median(age),
    mean = mean(age),
    max = max(age)
  ) %>% 
  mutate(
    min = formatC(signif(min, digits = 4), digits = 1, format = "f"),
    median = formatC(signif(median, digits = 4), digits = 1, format = "f"),
    mean = formatC(signif(mean, digits = 4), digits = 1, format = "f"),
    max = formatC(signif(max, digits = 4), digits = 1, format = "f")
  ) %>%
  select(-penetrate) %>% 
  as.data.frame()
rownames(age_summary) <- c("No Penetration", "Tumor Penetration")
age_summary %>%
  kable(caption = "Summary statistics of patient age grouped by whether tumor penetration of prostatic capsule occured.") %>% 
  column_spec(1, bold = TRUE) %>% 
  row_spec(0, bold = TRUE)
```


```{r app-psa-sum}
psa_summary <- prostate %>% 
  group_by(penetrate) %>% 
  summarise(
    min = min(psa),
    median = median(psa),
    mean = mean(psa),
    max = max(psa)
  ) %>%
  mutate(
    min = formatC(signif(min, digits = 4), digits = 1, format = "f"),
    median = formatC(signif(median, digits = 4), digits = 1, format = "f"),
    mean = formatC(signif(mean, digits = 4), digits = 1, format = "f"),
    max = formatC(signif(max, digits = 4), digits = 1, format = "f")
  ) %>%
  select(-penetrate) %>% 
  as.data.frame()
rownames(psa_summary) <- c("No Penetration", "Tumor Penetration")
psa_summary %>% 
  kable(caption = "Summary statistics for prostate specific antigen value grouped by whether tumor penetration of prostatic capsule occured.") %>%
  column_spec(1, bold = TRUE) %>% 
  row_spec(0, bold = TRUE)
```



## Figures


```{r app-age-box, fig.cap = "Boxplot of age vs. whether tumor penetration of prostatic capsule occured.", fig.height = 3, fig.width = 5}
ggplot(prostate, aes(x = penetrate, y = age)) +
  geom_boxplot() +
  theme_classic()
```


# Model Building and Diagnostics

## Intermediate Models

```{r app-best-step-sum}
tidy_best_step <- tidy(best_step) %>% 
  select(-statistic) %>%
  mutate(
    Term = term,
    Estimate = formatC(signif(estimate, digits = 4), digits = 2, format = "f"),
    SE = formatC(signif(std.error, digits = 4), digits = 2, format = "f"),
    `p-value` = formatC(signif(p.value, digits = 4), digits = 3, format = "f")
  ) %>% 
  select(Term, Estimate, SE, `p-value`)

tidy_best_step %>%
  kable(caption = "Summary of best stepwise fit of tumor penetration of prostatic capsule against age, race, digital rectal exam result, prostate specific antigen value, total Gleason score and the interaction terms age * dre results and race * psa. AIC is 391.") %>%
  row_spec(0, bold = TRUE)

```


## Diagnostics

```{r app-diag-plots, fig.height = 3, fig.width = 7, fig.cap = "Diagnostic plots for the model fit on explanatory variable patterns. Left: Cook's distance vs. leverage. Right: squared Pearson standardized residuals vs. fitted probabilities"}

cook_vs_lev <- ggplot(aug_diag, aes(x = .hat, y = .cooksd)) +
  geom_point() +
  geom_vline(xintercept = h_cutoff2, linetype = "dotted") +
  geom_vline(xintercept = h_cutoff3, linetype = "dotted") +
  geom_hline(yintercept = cook_cutoff, linetype = "dotted") +
  ylab("Cook's Distance") +
  xlab("Leverage") +
  theme_classic()
  
deltax_vs_fit <- ggplot(aug_diag, aes(x = .fitted, y = .std.resid^2)) +
  geom_point() +
  geom_hline(yintercept = 4) +
  geom_hline(yintercept = 9) +
  ylab("Squared Residuals") +
  xlab("Fitted Values") +
  theme_classic()


grid.arrange(cook_vs_lev, deltax_vs_fit, ncol = 2) 
```

## Inferences

```{r app-roc, fig.height = 3, fig.width = 6, fig.cap = "Reciever Operating Characteristic curve for final model fitting tumor penetration of prostatic capsule with covariates digital rectal exam result, prostate specific antigen value, and total Gleason score. The dotted line is a reference line indicating what the curve would be if we randomly decided whether tumor penetration occured."}
data.frame(
  sensitivity = fit_roc$sensitivities,
  specificity = fit_roc$specificities
) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity)) +
  geom_line() +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  annotate("text", label = paste0("AUC = ", round(fit_roc$auc, 2)),
           x = 0.75, y = 0.5) +
  theme_classic()
```


# R Code




