---
title: "Something About Prostate Cancer"
author: "Andrew Bates"
date: "November 15, 2018"
header-includes:
  - \renewcommand{\abstractname}{Executive Summary}
output: 
  bookdown::pdf_document2:
    toc: false
documentclass: article
geometry: margin=1in
fontsize: 11pt
abstract: "This is the executive summary. Unfortunately, it has to be typed in the .yaml header. The only other thing i can think of is to have a separate file for the abstract. I'm not sure I want to do this. But actually, this may not be so bad. Each section could have a different file. this might make things a bit easier to edit. because then i would only have to look at say, the conclusion file instead of having to scroll all the way down, passing it, srolling up, passing it, etc."
---

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(here)  # handles directories
library(readr)  # read in data
library(dplyr)  # manipulate data
library(forcats) # handle factors
library(ggplot2)  # plotting

library(knitr)
library(kableExtra)

prostate <- read_tsv(here("data", "prostate.txt"))
# remove id, rename
prostate <- prostate %>%
  select(-id)

prostate <- prostate %>%
  rename(
    penetrate = capsule,
    dre = dpros,
    caps = dcaps
  )

# re-encode variables
prostate <- prostate %>%
  mutate(
    penetrate = as.factor(penetrate),
    race = as.factor(race),
    dre = as.factor(dre),
    caps = as.factor(caps)
  ) %>%
  mutate(
    penetrate = fct_recode(penetrate, yes = "1", no = "0"),
    race = fct_recode(race, white = "1", black = "2"),
    caps = fct_recode(caps, no = "1", yes = "2"),
    dre = fct_recode(dre,
                     "no nodule" = "1",
                     "unilobar left" = "2",
                     "unilobar right" = "3",
                     "bilobar" = "4")
  )
# remove missing observations
prostate <- prostate %>%
  filter(!is.na(race))
```



# Introduction

In this paper, we investigate the relationship between the results of various prostae related exams and whether tumor penetration of the prostatic capsule has occured. 
The objective of this analysis is to determine if there are any factors that have a particularly influential relationship with prostatic capsule penetration.
Additionally, we wish to develop a model to predict capsule penetration so it can be used as a diagnostic tool for future patients.

# Methods

In this analysis we examine a subset of data collected by the Ohio State University Comprehensive Cancer Center as part of a study to determine the potential of standard exam results to predict whether a tumor will penetrate the prostatic capsule.
Out of $380$ patients, $153$ have experienced capsule penetration and $227$ have not. 
The data set contains six explanatory variables: the patients age and race, results of a digital rectal exam (DRE), whether capsular involvement was detected, Prostatic Specific Antigen (PSA) value, and total Gleason score.
For a detailed description of each variable see Table \@ref(tab:var-desc). Observe that race is recorded as only Black or White.
This may be the reason why three observations contain missing values for race. Perhaps three of the patients were neither Black nor White.
However, without access to details of the study and the population considered, we can only speculate. 
Furthermore, the other variables in these observations do not point to any particular reason as to why race is not recorded[^1].
Because of this, we decided to omit these three observations. 
The data set used for analysis then, consists of 377 observations. 
Of these, 151 patients have experienced tumor penetration of the prostatic capsule, and 226 have not.

To investigate the relationship between the covariates and tumor penetration status, we use a logistic regression model. 
The response is especially well balanced with 40% of the observations having capsular penetration and 60% not having penetration. 
As such, procedures designed to assist with class imbalances, such as downsampling, are not considered in this analysis.
In addition to the explanatory variables included in the data set, all two-way interaction terms are examined. 
Using this as a starting point, the model is chosen via a backwards elimination procedure using Akaike Information Criteria (AIC) as the model selection criterion.
(variable name) is not significant at the 0.05 level so it is subsequently removed, along with its corresponding interaction terms.

Diagnostics take the form of examining explanatory variable patterns. 
also do blah test.

log odds ratios were calculated, and predictions were made. predictive power was examined through a confusion matrix. What's more important here, false negatives or false positives?


<!-- Table: (\#tab:var-description) Description of variables in the data set. -->

<!-- | Variable Name | Description | Details | -->
<!-- |:------|:-----|:-----| -->
<!-- | capsule | Did the tumor penetrate the prostatic capsule | Yes, no | -->
<!-- | age | Patient age| In years | -->
<!-- | race | Patient race | Black or White | -->
<!-- | dre | Results of digital rectal exam | No nodule, unilobar nodule left, unilobar nodule left right, bilobar nodule | -->
<!-- | caps | Detection of capsular involvement | Yes, no | -->
<!-- | psa | Prostatic Specific Antigen value | mg/ml | -->
<!-- | gleason | Total Gleason score | 0-10 | -->

```{r var-desc}
description <- data.frame(
  Name = c("penetrate", "age", "race", "dre", "caps", "psa", "gleason"),
  Description = c("Tumor penetration of prostatic capsule?", "Patient age", "Patient race", "Results of digital rectal exam", "Detection of capsular involvement?", "Prostatic Specific Antigen value", "Total Gleason score"),
  Details = c("Yes, no", "Years", "Black, White", "No nodule, unilobar left, unilobar right, bilobar", "Yes, no", "mg/ml", "0-10")
)

kable(description,
      caption = "Description of variables in the data set.") %>%
  row_spec(0, bold = TRUE)

```


[^1]: As in, some have experienced capusle penetration, the ages and PSA scores vary significantly across the observations, etc.

# Analysis

## Exploratory Analysis

We begin by inspecting tables of the categorical variables against whether tumor penetration has occured. Rather than examing contingency tables of counts, we find it more informative to view tables marginalized by the covariates. This provides more context by allowing us to see, for example, the proportion of Black patients who had tumor penetration and the proportion who did not. Table \@ref(tab:dre-tab) displays the proportion of patients who did and did not experience tumor penetration of the prostatic capsule grouped by the results of a digital rectal exam. It shows that the majority of patients who do not have a nodule have not experience tumor penetration. For those patients who did have a nodule, the rate of tumor penetration is reversed. The most pronounced difference is for patients who had a bilobar nodule with 65% experiencing tumor penetration. The relationship we see here tells us that DRE results will likely be a valuable predictor.


```{r dre-tab}
dre_tab <- table(prostate$penetrate, prostate$dre) %>%
  prop.table(., margin = 2) * 100 
rownames(dre_tab) <- c("No Penetration", "Penetration")
dre_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Results of digital rectal exam vs. whether tumor pentration of prostatic capsule occured, marginalized by the digital rectal exam results.") %>% 
  add_header_above(c(" " = 1, "DRE Result" = 4), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```

The relationship for the remaining categorical variables can be found in Tables \@ref(tab:app-race-tab) to \@ref(tab:app-gleason-tab) in the appendix. For detection of capsular involvment and Gleason score, we find a similar story as DRE results. For patients where capsular involvement was detected, tumor penetration occured at more than twice the rate than patients where involvement was not detected (35% vs. 75%). As Gleason score increases from zero to nine, the tumor penetration rate increases from zero to 92%. Where we do not see a significant change in the rate of tumor penetration is with race. Both Black and White patients have a tumor penetration rate of approximately 40%.


## Modeling and Diagnostics

blah blah blah blah blah blah blah blah blah


# Conclusion



\newpage

# Appendix {-}

# (APPENDIX) Appendix A {-}


# Exploratory Analysis

## Tables

```{r app-race-tab}
race_tab <- table(prostate$penetrate, prostate$race) %>% 
  prop.table(., margin = 2) * 100
rownames(race_tab) <- c("No Penetration", "Penetration")
race_tab %>% 
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>%
  kable(caption = "Race vs. whether tumor penetration of prostatic capsule has occured, marginalized by race.") %>%
  add_header_above(c(" " = 1, "Race" = 2), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```


```{r app-caps-tab}
caps_tab <- table(prostate$penetrate, prostate$caps) %>%
  prop.table(., margin = 2) * 100
rownames(caps_tab) <- c("No Penetration", "Tumor Penetration")
caps_tab %>%
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Detection of capsular involvement vs. whether tumor pentration of prostatic capsule occured, marginalized by capsular involvment.") %>% 
  #column_spec(1, bold = TRUE, border_left = TRUE) %>% 
  #column_spec(3, border_right = TRUE) %>% 
  add_header_above(c(" ", "Capsular Involvement" = 2), bold = TRUE) %>% 
  column_spec(1, bold = TRUE)

```


```{r app-gleason-tab}
gleason_tab <- table(prostate$penetrate, prostate$gleason) %>%
  prop.table(., margin = 2) * 100
rownames(gleason_tab) <- c("No Penetration", "Tumor Penetration")
gleason_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Total Gleason score vs. whether tumor penetration of prostatic capsule occured, marginalized by Gleason score.") %>%
  add_header_above(c(" ", "Gleason Score" = 7), bold = TRUE) %>%
  column_spec(1, bold = TRUE)
```




## Figures

# Model Building and Diagnostics

## Intermediate Models

## Diagnostics


# R Code




