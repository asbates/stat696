---
title: "Something About Prostate Cancer"
author: "Andrew Bates"
date: "November 15, 2018"
header-includes:
  - \renewcommand{\abstractname}{Executive Summary}
output: 
  bookdown::pdf_document2:
    toc: false
documentclass: article
geometry: margin=1in
fontsize: 11pt
abstract: "This is the executive summary. Unfortunately, it has to be typed in the .yaml header. The only other thing i can think of is to have a separate file for the abstract. I'm not sure I want to do this. But actually, this may not be so bad. Each section could have a different file. this might make things a bit easier to edit. because then i would only have to look at say, the conclusion file instead of having to scroll all the way down, passing it, srolling up, passing it, etc."
---

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(here)  # handles directories
library(readr)  # read in data
library(MASS) # stepwise regression
library(dplyr)  # manipulate data
library(forcats) # handle factors
library(ggplot2)  # plotting
library(broom) # tidy model output
library(gridExtra) # matrix of ggplot's 

library(knitr)  # table formatting
library(kableExtra) # table formatting

prostate_raw <- read_tsv(here("data", "prostate.txt"))
# remove id, rename
prostate <- prostate_raw %>%
  select(-id)

prostate <- prostate %>%
  rename(
    penetrate = capsule,
    dre = dpros,
    caps = dcaps
  )

# re-encode variables
prostate <- prostate %>%
  mutate(
    penetrate = as.factor(penetrate),
    race = as.factor(race),
    dre = as.factor(dre),
    caps = as.factor(caps)
  ) %>%
  mutate(
    penetrate = fct_recode(penetrate, yes = "1", no = "0"),
    race = fct_recode(race, white = "1", black = "2"),
    caps = fct_recode(caps, no = "1", yes = "2"),
    dre = fct_recode(dre,
                     "no nodule" = "1",
                     "unilobar left" = "2",
                     "unilobar right" = "3",
                     "bilobar" = "4")
  )
# remove missing observations
prostate <- prostate %>%
  filter(!is.na(race))
```



# Introduction

In this paper, we investigate the relationship between the results of various prostae related exams and whether tumor penetration of the prostatic capsule has occured. 
The objective of this analysis is to determine if there are any factors that have a particularly influential relationship with prostatic capsule penetration.
Additionally, we wish to develop a model to predict capsule penetration so it can be used as a diagnostic tool for future patients.

# Methods

In this analysis we examine a subset of data collected by the Ohio State University Comprehensive Cancer Center as part of a study to determine the potential of standard exam results to predict whether a tumor will penetrate the prostatic capsule.
Out of $380$ patients, $153$ have experienced capsule penetration and $227$ have not. 
The data set contains six explanatory variables: the patients age and race, results of a digital rectal exam (DRE), whether capsular involvement was detected, Prostatic Specific Antigen (PSA) value, and total Gleason score.
For a detailed description of each variable see Table \@ref(tab:var-desc). Observe that race is recorded as only Black or White.
This may be the reason why three observations contain missing values for race. Perhaps three of the patients were neither Black nor White.
However, without access to details of the study and the population considered, we can only speculate. 
Furthermore, the other variables in these observations do not point to any particular reason as to why race is not recorded[^1].
Because of this, we decided to omit these three observations. 
The data set used for analysis then, consists of 377 observations. 
Of these, 151 patients have experienced tumor penetration of the prostatic capsule, and 226 have not.

To investigate the relationship between the covariates and tumor penetration status, we use a logistic regression model. 
The response is especially well balanced with 40% of the observations having capsular penetration and 60% not having penetration. 
As such, procedures designed to assist with class imbalances, such as downsampling, are not considered in this analysis.
In addition to the explanatory variables included in the data set, all two-way interaction terms are examined. 
Using this as a starting point, the model is chosen via a backwards elimination procedure using Akaike Information Criteria (AIC) as the model selection criterion.
(variable name) is not significant at the 0.05 level so it is subsequently removed, along with its corresponding interaction terms.

Diagnostics take the form of examining explanatory variable patterns. 
also do blah test.

log odds ratios were calculated, and predictions were made. predictive power was examined through a confusion matrix. What's more important here, false negatives or false positives?


<!-- Table: (\#tab:var-description) Description of variables in the data set. -->

<!-- | Variable Name | Description | Details | -->
<!-- |:------|:-----|:-----| -->
<!-- | capsule | Did the tumor penetrate the prostatic capsule | Yes, no | -->
<!-- | age | Patient age| In years | -->
<!-- | race | Patient race | Black or White | -->
<!-- | dre | Results of digital rectal exam | No nodule, unilobar nodule left, unilobar nodule left right, bilobar nodule | -->
<!-- | caps | Detection of capsular involvement | Yes, no | -->
<!-- | psa | Prostatic Specific Antigen value | mg/ml | -->
<!-- | gleason | Total Gleason score | 0-10 | -->

```{r var-desc}
description <- data.frame(
  Name = c("penetrate", "age", "race", "dre", "caps", "psa", "gleason"),
  Description = c("Tumor penetration of prostatic capsule?", "Patient age", "Patient race", "Results of digital rectal exam", "Detection of capsular involvement?", "Prostatic Specific Antigen value", "Total Gleason score"),
  Details = c("Yes, no", "Years", "Black, White", "No nodule, unilobar left, unilobar right, bilobar", "Yes, no", "mg/ml", "0-10")
)

kable(description,
      caption = "Description of variables in the data set.") %>%
  row_spec(0, bold = TRUE)

```


[^1]: As in, some have experienced capusle penetration, the ages and PSA scores vary significantly across the observations, etc.

# Analysis

## Exploratory Analysis

We begin by inspecting tables of the categorical variables against whether tumor penetration has occured. Rather than examing contingency tables of counts, we find it more informative to view tables marginalized by the covariates. This provides more context by allowing us to see, for example, the proportion of Black patients who had tumor penetration and the proportion who did not. Table \@ref(tab:dre-tab) displays the proportion of patients who did and did not experience tumor penetration of the prostatic capsule grouped by the results of a digital rectal exam. It shows that the majority of patients who do not have a nodule have not experience tumor penetration. For those patients who did have a nodule, the rate of tumor penetration is reversed. The most pronounced difference is for patients who had a bilobar nodule with 65% experiencing tumor penetration. The relationship we see here tells us that DRE results will likely be a valuable predictor.


```{r dre-tab}
dre_tab <- table(prostate$penetrate, prostate$dre) %>%
  prop.table(., margin = 2) * 100 
rownames(dre_tab) <- c("No Penetration", "Penetration")
dre_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Results of digital rectal exam vs. whether tumor pentration of prostatic capsule occured, marginalized by the digital rectal exam results.") %>% 
  add_header_above(c(" " = 1, "DRE Result" = 4), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```

The relationship for the remaining categorical variables can be found in Tables \@ref(tab:app-race-tab) to \@ref(tab:app-gleason-tab) in the appendix. For detection of capsular involvment and Gleason score, we find a similar story as DRE results. For patients where capsular involvement was detected, tumor penetration occured at more than twice the rate than patients where involvement was not detected (35% vs. 75%). As Gleason score increases from zero to nine, the tumor penetration rate increases from zero to 92%. Where we do not see a significant change in the rate of tumor penetration is with race. Both Black and White patients have a tumor penetration rate of approximately 40%.

For the numeric variables, we examine summary statistics and plots of age and PSA grouped by whether prostatic capusle penetration has occured. Summary statistics and a box plot for age can be found in Table \@ref(tab:app-age-sum) and Figure \@ref(fig:app-age-box). There is virtually no difference in the age distribution of patients who have experience tumor penetration and those who have not. As such, we do not expect it to make a significant contribution to our model. On the other hand, PSA value seems like it may be an important predictor.
Figure \@ref(fig:psa-hist) is a histogram of PSA value where color indicates tumor penetration of the prostatic capsule. The distribution has a similar shape for low PSA values however, for PSA values above 67 mg/ml there are no cases where tumor penetration has occured. 


```{r psa-hist, fig.cap = "Histogram of prostatic specific antigen value colored by whether tumor penetration of prostatic capsule occured.", fig.height = 3.5, fig.width = 6}
ggplot(prostate, aes(x = psa, fill = penetrate)) +
  geom_histogram(bins = 50) +
  theme_classic()
```


Before we move on to the modeling phase of our analysis, it might be beneficial to summarize what we have found so far.

## Modeling

```{r model-setup}
best_step <- glm(penetrate ~ age + race + dre + psa + gleason + 
    age:dre + age:gleason + race:psa, 
    family = binomial(link = "logit"), 
    data = prostate)

```


To model the relationship between tumor penetration and the predictor variables, we use a logistic regression model. As most of the covariates are tests covering different aspects of of the prostate, it is not hard to imagine there some of them connected in their relationship with tumor penetration. For this reason, the initial model is fit using all first-order interaction terms. This serves as the starting point for model selection which is done via stepwise regression with AIC as the selection criteria. The model chosen via the stepwise procedure includes race, age, DRE results, PSA value, and Gleason score as well as age interacted with DRE result and race interacted with PSA value. A detailed summary can be found in Table \@ref(tab:app-best-step-sum). We note here that the AIC is 391 and the p-values for age and race are quite high at 0.11 and 0.99, respectively.

Since some of the p-values of the model obtained via stepwise regression, we remove this terms and refit our model. Specifically, we remove age and race along with interaction terms associated with them. We can not justify keeping variables in interactions that themselves are not included in the model. Note that for this model, removing the relevant interaction terms actually means removing all interaction terms. Once this is done, we are left with a model that relates tumor penetration to just three variables: DRE results, PSA value, and Gleason score.

## Diagnostics

```{r diag-setup, fig.show = "hide"}
# functions used for residual analysis
one_fourth_root=function(x){
  x^(0.25)
}
source(here("reports", "prostate-cancer","code","examine.logistic.reg.R"))

# note: we're using the 'raw' data here with the default encoding
pros_diag <- prostate_raw %>% 
  rename(
    penetrate = capsule,
    dre = dpros,
    caps = dcaps
  )


# Create EVPs by binning continuous covariates
g <- 5 # number of categories
psa_interval = cut(pros_diag$psa,
                   quantile(pros_diag$psa, 0:g/g), include.lowest = TRUE)

w <- aggregate(penetrate ~ psa_interval + gleason + dre,
               data = pros_diag,
               FUN = sum)
n <- aggregate(penetrate ~ psa_interval + gleason + dre,
               data = pros_diag,
               FUN = length)
wn <- data.frame(
  w,
  trials = n$penetrate, 
  prop = round(w$penetrate / n$penetrate, 2)
)


diag_fit <- glm(penetrate/trials ~ psa_interval + gleason + dre,
           data = wn,
           family = binomial(link = "logit"),
           weights = trials)

examine <- examine.logistic.reg(diag_fit,
                             identify.points = FALSE,
                             scale.n = one_fourth_root,
                             scale.cookd = sqrt)

wn_diag <- data.frame(
  wn,
  pi_hat = examine$pi.hat,
  std_res = examine$stand.resid,
  cooks_d = examine$cookd,
  h = round(examine$h, 2),
  fitted = diag_fit$fitted.values,
  dxsquare = examine$stand.resid^2
)
p <- length(diag_fit$coefficients)
```





# Conclusion



\newpage

# Appendix {-}

# (APPENDIX) Appendix A {-}


# Exploratory Analysis

## Tables

```{r app-race-tab}
race_tab <- table(prostate$penetrate, prostate$race) %>% 
  prop.table(., margin = 2) * 100
rownames(race_tab) <- c("No Penetration", "Penetration")
race_tab %>% 
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>%
  kable(caption = "Race vs. whether tumor penetration of prostatic capsule has occured, marginalized by race.") %>%
  add_header_above(c(" " = 1, "Race" = 2), bold = TRUE) %>%
  column_spec(1, bold = TRUE)

```


```{r app-caps-tab}
caps_tab <- table(prostate$penetrate, prostate$caps) %>%
  prop.table(., margin = 2) * 100
rownames(caps_tab) <- c("No Penetration", "Tumor Penetration")
caps_tab %>%
  signif(., digits = 4) %>% 
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Detection of capsular involvement vs. whether tumor pentration of prostatic capsule occured, marginalized by capsular involvment.") %>% 
  #column_spec(1, bold = TRUE, border_left = TRUE) %>% 
  #column_spec(3, border_right = TRUE) %>% 
  add_header_above(c(" ", "Capsular Involvement" = 2), bold = TRUE) %>% 
  column_spec(1, bold = TRUE)

```


```{r app-gleason-tab}
gleason_tab <- table(prostate$penetrate, prostate$gleason) %>%
  prop.table(., margin = 2) * 100
rownames(gleason_tab) <- c("No Penetration", "Tumor Penetration")
gleason_tab %>%
  signif(., digits = 4) %>%
  formatC(., digits = 1, format = "f") %>% 
  kable(caption = "Total Gleason score vs. whether tumor penetration of prostatic capsule occured, marginalized by Gleason score.") %>%
  add_header_above(c(" ", "Gleason Score" = 7), bold = TRUE) %>%
  column_spec(1, bold = TRUE)
```


```{r app-age-sum}
age_summary <- prostate %>% 
  group_by(penetrate) %>%
  summarise(
    min = min(age),
    median = median(age),
    mean = mean(age),
    max = max(age)
  ) %>% 
  mutate(
    min = formatC(signif(min, digits = 4), digits = 1, format = "f"),
    median = formatC(signif(median, digits = 4), digits = 1, format = "f"),
    mean = formatC(signif(mean, digits = 4), digits = 1, format = "f"),
    max = formatC(signif(max, digits = 4), digits = 1, format = "f")
  ) %>%
  select(-penetrate) %>% 
  as.data.frame()
rownames(age_summary) <- c("No Penetration", "Tumor Penetration")
age_summary %>%
  kable(caption = "Summary statistics of patient age grouped by whether tumor penetration of prostatic capsule occured.") %>% 
  column_spec(1, bold = TRUE) %>% 
  row_spec(0, bold = TRUE)
```

```{r app-psa-sum}
psa_summary <- prostate %>% 
  group_by(penetrate) %>% 
  summarise(
    min = min(psa),
    median = median(psa),
    mean = mean(psa),
    max = max(psa)
  ) %>%
  mutate(
    min = formatC(signif(min, digits = 4), digits = 1, format = "f"),
    median = formatC(signif(median, digits = 4), digits = 1, format = "f"),
    mean = formatC(signif(mean, digits = 4), digits = 1, format = "f"),
    max = formatC(signif(max, digits = 4), digits = 1, format = "f")
  ) %>%
  select(-penetrate) %>% 
  as.data.frame()
rownames(psa_summary) <- c("No Penetration", "Tumor Penetration")
psa_summary %>% 
  kable(caption = "Summary statistics for prostatic specific antigen value grouped by whether tumor penetration of prostatic capsule occured.") %>%
  column_spec(1, bold = TRUE) %>% 
  row_spec(0, bold = TRUE)
```



## Figures


```{r app-age-box, fig.cap = "Boxplot of age vs. whether tumor penetration of prostatic capsule occured.", fig.height = 3, fig.width = 5}
ggplot(prostate, aes(x = penetrate, y = age)) +
  geom_boxplot() +
  theme_classic()
```


# Model Building and Diagnostics

## Intermediate Models

```{r app-best-step-sum}
tidy_best_step <- tidy(best_step) %>% 
  select(-statistic) %>%
  mutate(
    Term = term,
    Estimate = formatC(signif(estimate, digits = 4), digits = 2, format = "f"),
    SE = formatC(signif(std.error, digits = 4), digits = 2, format = "f"),
    `p-value` = formatC(signif(p.value, digits = 4), digits = 3, format = "f")
  ) %>% 
  select(Term, Estimate, SE, `p-value`)

tidy_best_step %>%
  kable(caption = "Coefficient, standard error, and p-value for model chosen via stepwise procedure. AIC = 391") %>%
  row_spec(0, bold = TRUE)

```


## Diagnostics

```{r app-diag-plots}

resid_vs_fit <- ggplot(wn_diag, aes(x = std_res, y = fitted)) +
  geom_point() +
  geom_hline(yintercept = 2, linetype = "dotted") +
  geom_hline(yintercept = 3, linetype = "dotted") +
  geom_hline(yintercept = -2, linetype = "dotted") +
  geom_hline(yintercept = -3, linetype = "dotted") +
  ylab("Standardized Residuals") +
  xlab("Fitted Values") +
  theme_classic()

cook_cutoff <- 4 / nrow(wn)
h_cutoff2 <- 2 * p / nrow(wn)
h_cutoff3 <- 3 * p / nrow(wn)

cook_vs_lev <- ggplot(wn_diag, aes(x = h, y = cooks_d)) +
  geom_point() +
  geom_vline(xintercept = h_cutoff2, linetype = "dotted") +
  geom_vline(xintercept = h_cutoff3, linetype = "dotted") +
  geom_hline(yintercept = cook_cutoff, linetype = "dotted") +
  ylab("Cook's Distance") +
  xlab("Leverage") +
  theme_classic()
  
deltax_vs_fit <- ggplot(wn_diag, aes(x = fitted, y = dxsquare)) +
  geom_point() +
  geom_hline(yintercept = 4) +
  geom_hline(yintercept = 9) +
  ylab("Squared Residuals") +
  xlab("Fitted Values") +
  theme_classic()


grid.arrange(resid_vs_fit, cook_vs_lev, deltax_vs_fit, ncol = 2) 
```



# R Code




